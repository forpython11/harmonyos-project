"use strict";var t=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(t){i(t)}}function u(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.pingCmd=void 0;const n=e(require("../log")),r=require("../core/registry"),o=e(require("node-fetch")),i=require("../common/Constants");function s(e,s){return t(this,void 0,void 0,(function*(){s=`${e.trim().replace(/\/?$/g,"")}/${s.trim().replace(/^\//,"")}`;try{const t=yield(0,o.default)(s,{agent:(0,r.getProxyAgent)(e),timeout:(0,r.getFetchTimeout)(),redirect:"error"});return n.default.debug(`STATUS_${t.status}`,`- GET ${s}`),t.ok?t.json():(n.default.error("",`HttpCode ${t.status}, API ping in ${e} - ${t.statusText}`),404===t.status)}catch(t){return i.Constants.errnoList.includes(t.errno)?(n.default.error(t.errno,t.message),!1):i.Constants.errTypeMap[t.type]?(n.default.error(i.Constants.errTypeMap[t.type],t.message),!1):(n.default.error("",t.message),!1)}}))}exports.pingCmd=function(){return t(this,void 0,void 0,(function*(){const e=Date.now(),o=yield function(e){return t(this,void 0,void 0,(function*(){let t=!0;const o=(0,r.getRegistryList)("");for(const r of o){n.default.info("PING",r);const o=Date.now(),i=yield s(r,e);if(i){!0!==i&&n.default.info("PONG",`${JSON.stringify(i,null,2)}`);const t=Date.now()-o;n.default.info("PONG",`${t}ms`)}else t=!1}return t}))}("/-/ping"),i=Date.now()-e;n.default.info("PONG",`Total ${i}ms`),o?process.exit(0):process.exit(1)}))};