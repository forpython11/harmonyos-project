"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(n){if(n&&n.__esModule)return n;var o={};if(null!=n)for(var i in n)"default"!==i&&Object.prototype.hasOwnProperty.call(n,i)&&e(o,n,i);return t(o,n),o},o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkFileIfExist=exports.deleteExtraneousLinks=exports.getPkgRootDirName=exports.updateMaxVersionMap=exports.pkgMaxVersionMap=exports.pkgPathToNodeMap=exports.updatePkgJson=exports.getRootNode=exports.getChildren=exports.getPinnedVersion=exports.getPackageInfo=exports.getPackageInfoLocalFirst=void 0;const r=n(require("semver")),s=i(require("../../../log")),a=n(require("lodash")),c=require("../../registry/registry"),d=i(require("path")),p=require("../../../util"),u=require("../../package"),l=require("../../../common/message"),f=require("../../../common/Constants"),g=require("../../package/PackageLock"),k=require("../packages/PackageFactory"),v=require("../packages/RegistryPackage"),h=require("../../../common/GlobalState");function P(e,t){let n=t;if("latest"===n&&(n="*"),r.valid(t)&&e.includes(t))return t;return r.maxSatisfying(e,n)||r.maxSatisfying(e,n,{includePrerelease:!0,loose:!0})}exports.getPackageInfoLocalFirst=function(e,t){return o(this,void 0,void 0,(function*(){const n=g.PackageLock.getLockSpec(e,t),o=g.PackageLock.getLockPkg(e,t);if(n&&o&&o.integrity){const t={};return t[p.PackageUtil.parse(n).version||""]=o,{name:e,versions:t,isFromLockFile:!0}}const i=yield(0,exports.getPackageInfo)(e),r=i.versions,s=P(Object.keys(r),t);if(null!==s){const t=r[s],n=t.dist,o={resolved:n.tarball,integrity:n.integrity,dependencies:t.dependencies};g.PackageLock.updateLockPkg(e,s,o)}return i}))},exports.getPackageInfo=a.memoize((e=>o(void 0,void 0,void 0,(function*(){return(0,c.fetchPackageInfo)(e)})))),exports.getPinnedVersion=function(e,t,n){const o=g.PackageLock.getLockSpec(e,t);if(o){const t=p.PackageUtil.parse(o);if(!t.version||!r.valid(t.version))throw"";return{name:e,version:t.version}}const i=P(Object.keys(n.versions),t);if(null===i){const n=(0,l.getMessage)("install.noMatch",{name:e,version:t});throw s.default.error("",n),new Error(n)}return{name:e,version:i}},exports.getChildren=function(e,t,n){return o(this,void 0,void 0,(function*(){const o=t.name,i=t.fetchSpec,r=n.versions[i].dependencies||{};for(const n of Object.keys(r)){if(r[n].startsWith("file:")){yield t.fetch(e),yield t.install(e);break}}return Object.keys(r).filter((e=>{const t=r[e];if(e===o)throw s.default.error("Invalid dependency",`${o}@${i} -> ${e}@${t}`),new Error;return!0})).map((n=>k.PackageFactory.getPackage(e,`${n}@${r[n]}`,t.pkgStoreDir,!1,n)))}))},exports.getRootNode=function(e,t,n){return o(this,void 0,void 0,(function*(){p.PackageUtil.checkIfPackageJsonExists(e);const o=new v.RegistryPackage(".",".");let i={dependencies:{},devDependencies:{}};const r=d.default.join(e,f.Constants.MyPackageJson);i=p.FsUtil.readJSON5Sync(r),i.dependencies=i.dependencies||{},i.devDependencies=i.devDependencies||{};const s=new Set;for(const r of n){let n=r;if(h.GlobalState.command===h.CommandType.UPDATE){let e=i.devDependencies[n];e||(e=i.dependencies[n]),n=e?`${n}@${e}`:void 0}if(n){const r=k.PackageFactory.getPackage(e,n,e,t.link);h.GlobalState.command===h.CommandType.UNINSTALL?(delete i.dependencies[r.name],delete i.devDependencies[r.name]):h.GlobalState.command===h.CommandType.INSTALL&&(yield r.init(e,!0),o.children.push(r),s.add(r.name),t.saveDev?i.devDependencies[r.name]=r.saveSpec:t.save&&(i.dependencies[r.name]=r.saveSpec))}}return o.packageJson=i,t.prod||Object.keys(i.devDependencies||{}).forEach((n=>{if(!s.has(n)){const r=i.devDependencies[n],s=k.PackageFactory.getPackage(e,`${n}@${r}`,e,t.link,n);o.children.push(s)}})),Object.keys(i.dependencies||{}).forEach((n=>{if((t.prod||!i.devDependencies[n])&&!s.has(n)){const r=i.dependencies[n],s=k.PackageFactory.getPackage(e,`${n}@${r}`,e,t.link,n);o.children.push(s)}})),o}))},exports.updatePkgJson=function(e,t,n){return o(this,void 0,void 0,(function*(){n.save&&(n.saveDev||n.saveProd)&&(yield(0,u.updatePackageJson)(e,{dependencies:t.dependencies,devDependencies:t.devDependencies}))}))},exports.pkgPathToNodeMap=new Map,exports.pkgMaxVersionMap=new Map,exports.updateMaxVersionMap=function(e,t){const n=exports.pkgMaxVersionMap.get(e);n&&!r.gtr(t.fetchSpec,n.fetchSpec)||exports.pkgMaxVersionMap.set(e,t)},exports.getPkgRootDirName=function(e,t){return`${e}@${t}`.replace(/\//g,"+").replace(/:/g,"+")},exports.deleteExtraneousLinks=function(e,t){if(!p.FsUtil.existsSync(e))return;const n=p.FsUtil.readdirSync(e);for(const o of n){if(o===f.Constants.PmDir)continue;const n=d.default.join(e,o);if(!o.startsWith("@")){t(o)||p.FsUtil.rmDirSync(n);continue}const i=p.FsUtil.readdirSync(n);let r=i.length;for(const e of i)if(!t(`${o}/${e}`)){const t=d.default.join(n,e);p.FsUtil.rmDirSync(t),r--}r<=0&&p.FsUtil.rmDirSync(n)}},exports.checkFileIfExist=function(e){p.FsUtil.existsSync(e)||(s.default.error("",`File: ${e} does not exist.`),process.exit(1))};