"use strict";var e=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(a,n){function r(e){try{c(s.next(e))}catch(e){n(e)}}function o(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((s=s.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RegistryPackage=void 0;const i=t(require("path")),s=require("../../../util"),a=require("../../../common/Constants"),n=t(require("../../../log")),r=require("./AbstractPackage"),o=require("../service/common"),c=require("../service/common"),h=require("../../cache"),l=t(require("tar")),u=require("../../registry/registry"),d=require("../../../util/validatePackage"),f=require("../../package/PackageLock");let p=1;class g extends r.AbstractPackage{constructor(e,t){super(e,t,t)}init(t,s=!1){return e(this,void 0,void 0,(function*(){const e=i.default.join(t,a.Constants.MyModules,a.Constants.PmDir),n=yield(0,o.getPackageInfoLocalFirst)(this.name,this.fetchSpec),r=(0,o.getPinnedVersion)(this.name,this.fetchSpec,n);this.fetchSpec=r.version,n.isFromLockFile||(0,u.checkRegistry)(this.name,this.fetchSpec,n);const h=(0,c.getPkgRootDirName)(r.name,r.version),l=i.default.join(e,h);this.saveRootDir=l,this.pkgStoreDir=i.default.join(this.saveRootDir,a.Constants.MyModules,this.name),c.pkgPathToNodeMap.has(l)||(s&&(this.saveSpec=`^${r.version}`),f.PackageLock.updateLockSpec(this.name,this.saveSpec,r.version),this.children=yield(0,o.getChildren)(t,this,n),(0,c.updateMaxVersionMap)(r.name,this),c.pkgPathToNodeMap.set(l,this))}))}fetch(t){return e(this,void 0,void 0,(function*(){n.default.debug("fetching package",`${this.name}@${this.fetchSpec}`),this.cachePath=yield(0,h.getPkgPath)(this.name,this.fetchSpec,t)}))}install(t){return e(this,void 0,void 0,(function*(){const t=this.name,i=this.fetchSpec,r=yield s.FsUtil.readFileSync(this.cachePath);yield function(t){return e(this,void 0,void 0,(function*(){if(t.length>a.Constants.InstallMaxPackSize)throw new Error(`total pack size is more than ${a.Constants.InstallMaxPackSize}`);let e=0,i=0;const s=l.default.list({onentry(t){if("Directory"===t.type)return;const s=function(e){const t=[],i=[];/(\/\.\.\/)|(\.\.\/)|(\/\.\.)|(\.\.$)/gi.test(e)&&t.push(`${e},cannot contain special characters .. or ../`);return(0,d.done)(i,t)}(t.path);if(!s.validForPackages)throw new Error(s.errors);if(e++,e>a.Constants.TotalFiles)throw new Error(`total number of files is more than ${a.Constants.TotalFiles}`);if(i+=void 0===t.size?0:t.size,i>a.Constants.InstallMaxUnpackSize)throw new Error(`total file size is more than ${a.Constants.InstallMaxUnpackSize}`)}});s.end(t)}))}(r),s.FsUtil.createDirIfNotExists(this.pkgStoreDir),yield l.default.extract({file:this.cachePath,cwd:this.pkgStoreDir,strip:1}),this.ensureOhPackageJson5(this.pkgStoreDir),n.default.debug("place package done "+p++,`${t}@${i} to ${this.pkgStoreDir}`)}))}}exports.RegistryPackage=g;