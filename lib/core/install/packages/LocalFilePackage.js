"use strict";var t=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))((function(a,n){function o(t){try{c(i.next(t))}catch(t){n(t)}}function r(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalFilePackage=void 0;const s=require("./AbstractPackage"),i=e(require("path")),a=require("../../../common/Constants"),n=require("../../../util"),o=e(require("../../../log")),r=e(require("tar")),c=require("uuid"),l=require("../service/common");class u extends s.AbstractPackage{constructor(t,e,s){if(!n.FsUtil.existsSync(e))throw o.default.error("",`Fetch local package error, ${e} not found.`),"";const l=(0,c.v4)().replace(/-/g,"").slice(0,12),u=i.default.join(t,a.Constants.MyModules,`.tmp.${l}`);n.FsUtil.createDirIfNotExists(u);const h={file:e,cwd:u,strip:1,sync:!0};r.default.extract(h,[`package/${a.Constants.MyPackageJson}`,`package/${a.Constants.PackageJson}`]);const f=i.default.join(u,a.Constants.MyPackageJson),d=i.default.join(u,a.Constants.PackageJson);let g;if(n.FsUtil.existsSync(f))g=n.FsUtil.readJSON5Sync(f,a.Constants.MyPackageJson);else{if(!n.FsUtil.existsSync(d))throw o.default.error("",`Fetch local package error, the ${a.Constants.MyPackageJson} file is missing in ${e}.`),n.FsUtil.rmDirSync(u),"";g=n.FsUtil.readJSON5Sync(d,a.Constants.PackageJson)}n.FsUtil.rmDirSync(u);const p=`file:${k=t,y=e.replace(/#/g,"%23"),i.default.relative(k,y).replace(/\\/g,"/")}`;var k,y;const P=s||g.name;n.PackageUtil.requireNotEmpty(g.name,`The name field in the oh-package.json5 file of ${e}`),super(P,e,p),this.packageJson=g}init(e){return t(this,void 0,void 0,(function*(){const t=i.default.join(e,a.Constants.MyModules,a.Constants.PmDir),s=(0,l.getPkgRootDirName)(this.name,this.saveSpec),n=i.default.join(t,s);if(this.saveRootDir=n,this.pkgStoreDir=i.default.join(this.saveRootDir,a.Constants.MyModules,this.name),l.pkgPathToNodeMap.has(n))return;const o={versions:{[this.fetchSpec]:this.packageJson}};this.children=yield(0,l.getChildren)(e,this,o),l.pkgPathToNodeMap.set(n,this)}))}install(e){return t(this,void 0,void 0,(function*(){n.FsUtil.createDirIfNotExists(this.pkgStoreDir),r.default.extract({file:this.fetchSpec,cwd:this.pkgStoreDir,strip:1,sync:!0}),this.ensureOhPackageJson5(this.pkgStoreDir)}))}}exports.LocalFilePackage=u;