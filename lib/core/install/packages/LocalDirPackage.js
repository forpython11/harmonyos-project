"use strict";var t=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(o,n){function r(t){try{c(s.next(t))}catch(t){n(t)}}function a(t){try{c(s.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((s=s.apply(t,e||[])).next())}))},e=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalDirPackage=void 0;const i=e(require("path")),s=require("../../../util"),o=require("../../../common/Constants"),n=e(require("../../../log")),r=require("./AbstractPackage"),a=require("../service/common");class c extends r.AbstractPackage{constructor(t,e,r,a){if(!s.FsUtil.existsSync(e))throw n.default.error("",`Fetch local folder package error, ${e} does not exist.`),new Error;const c=i.default.join(e,o.Constants.MyPackageJson);if(!s.FsUtil.existsSync(c))throw n.default.error("",`Fetch local folder package error, ${c} does not exist.`),new Error;const l=s.FsUtil.readJSON5Sync(c),u=`file:${h=t,d=e.replace(/#/g,"%23"),i.default.relative(h,d).replace(/\\/g,"/")}`;var h,d;const f=a||l.name;s.PackageUtil.requireNotEmpty(f,`The name of package ${e}`),super(f,e,u),this.isLink=r,this.packageJson=l}init(e){return t(this,void 0,void 0,(function*(){const t=i.default.join(e,o.Constants.MyModules,o.Constants.PmDir),s=(0,a.getPkgRootDirName)(this.name,this.saveSpec),n=i.default.join(t,s);if(this.saveRootDir=n,this.pkgStoreDir=i.default.join(this.saveRootDir,o.Constants.MyModules,this.name),!a.pkgPathToNodeMap.has(n)&&!this.isLink){const t={versions:{[this.fetchSpec]:this.packageJson}};this.children=yield(0,a.getChildren)(e,this,t),a.pkgPathToNodeMap.set(n,this)}}))}install(e){return t(this,void 0,void 0,(function*(){if(!0===this.isLink)return;const t=i.default.join(this.fetchSpec,o.Constants.NodeModules),e=i.default.join(this.fetchSpec,o.Constants.MyModules),n={errorOnExist:!0,recursive:!0,filter:(i,s)=>!i.startsWith(t)&&!i.startsWith(e)};s.FsUtil.copySync(this.fetchSpec,this.pkgStoreDir,n)}))}symlink(e,i){const s=Object.create(null,{symlink:{get:()=>super.symlink}});return t(this,void 0,void 0,(function*(){!0!==this.isLink&&(yield s.symlink.call(this,e,i))}))}}exports.LocalDirPackage=c;