"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var i={};if(null!=r)for(var a in r)"default"!==a&&Object.prototype.hasOwnProperty.call(r,a)&&e(i,r,a);return t(i,r),i},i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function s(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}l((i=i.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.publish=void 0;const o=r(require("../registry/registry")),n=r(require("tar")),s=require("./common"),l=a(require("process")),c=a(require("fs-extra")),u=require("uuid"),d=require("../../util/validatePackage"),f=a(require("ignore-walk")),h=require("./ignore"),g=require("../../util"),y=require("../../common/Constants");exports.publish=function(e,t){return i(this,void 0,void 0,(function*(){const r=l.default.cwd();if(void 0===e||g.FsUtil.statSync(e).isDirectory())throw new Error("You have to specify a correct har_file path.");let a=yield(0,s.getManifest)(e,r);a=yield(0,s.patchManifest)(a);const v=a.cache;!function(e,t){let r=(0,d.validatePackageName)(e.name);if(!r.validForPackages)throw new Error(r.errors);if(r=(0,d.validateVersion)(e.version),!r.validForPackages)throw new Error(r.errors);if(r=(0,d.validateLength)(e),!r.validForPackages)throw new Error(r.errors);if(r=(0,d.validateTag)(t.tag),!r.validForPackages)throw new Error(r.errors)}(a,t),a.tag=t.tag;let p=o.getPublishRegistry();if(void 0!==t.publish_registry&&(p=t.publish_registry),null==p||!p.length)throw new Error(`The publish_registry url is empty - use "${y.Constants.PM} config set publish_registry your_publish_registry" command to set the url.`);p.endsWith("/")||(p=p.concat("/"));const w={tag:a.tag||"latest",registry:p};let _;_=c.default.statSync(e).isDirectory()?yield function(e,t){return i(this,void 0,void 0,(function*(){const r=t.cache;c.default.pathExistsSync(r)||c.default.mkdirsSync(r);const i=f.default.sync({path:e,ignoreFiles:h.ignore,includeEmpty:!0}),a=`${r}${(0,u.v4)().replace(/-/g,"")}${t.version}.har`,o={cwd:e,gzip:{level:9},prefix:"package",portable:!0,filter:e=>h.unpackFile.every((t=>e.toLowerCase()!==t))&&h.unpackDir.every((t=>!new RegExp(`^${t}/`).test(e.toLowerCase())))&&h.ignore.every((t=>e.toLowerCase()!==t)),file:a};return yield n.create(o,i),a}))}(e,a):e;const b=_,m=yield c.default.readFileSync(b),P=yield(0,s.getContents)(a,m);yield(0,s.logHar)(P,w);let k=(0,d.validateSize)(P);if(!k.validForPackages)throw new Error(k.errors);if(k=c.default.statSync(e).isDirectory()?(0,d.validateHmPackage)(a,e):(0,d.validateHmPackage)(a,v),!k.validForPackages)throw new Error(k.errors);const q=yield(0,s.buildMetadata)(p,a,m);c.default.removeSync(v),yield o.publishPackage(q,p),(0,g.output)(`+${a.name} ${a.version} `)}))};