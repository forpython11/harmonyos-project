"use strict";var t=this&&this.__createBinding||(Object.create?function(t,e,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(e,r);o&&!("get"in o?!e.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,o)}:function(t,e,r,n){void 0===n&&(n=r),t[n]=e[r]}),e=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),r=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var n={};if(null!=r)for(var o in r)"default"!==o&&Object.prototype.hasOwnProperty.call(r,o)&&t(n,r,o);return e(n,r),n},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getProxyAgent=void 0;const o=require("http-proxy-agent"),i=require("https-proxy-agent"),s=require("../../config"),u=n(require("../../log")),c=n(require("fs")),p=r(require("https")),f=n(require("url")),l=n(require("tunnel")),a=new Map;function g(t,e){if(!t)return!1;if("."===t[0])return e.endsWith(t);const r=t.split("*"),n=r.length;if(1===n)return t===e;if(2===n){const[t,n]=r;return e.startsWith(t)&&e.endsWith(n)&&e.length>=t.length+n.length}return!1}let h=!1;exports.getProxyAgent=function(t){if(function(){if(h)return;const t=s.config.get(s.types.STRICT_SSL);!1!==t&&"false"!==t||(process.removeAllListeners("warning"),process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),h=!0}(),a.has(t))return a.get(t);let e;try{e=new URL(t)}catch(e){return void u.default.error("",`An unknown error occurred while getting the proxy: ${t},`,`${e.message}`)}const r=s.config.get(s.types.STRICT_SSL),n=s.config.getString(s.types.CA_FILES),d=[];if(!0===r&&n){n.split(",").forEach((t=>{if(t){const e=c.default.readFileSync(t);d.push(e)}}))}let y;if(function(t){const e=s.config.getString(s.types.NO_PROXY).split(",");for(const r of e)if(g(r.trim(),t.hostname))return!0;return!1}(e))return!0===r&&d.length>0?(y=new p.Agent({rejectUnauthorized:!0,ca:d}),y):void 0;if("https:"===e.protocol.trim()){const t=s.config.getString(s.types.HTTPS_PROXY);t?y=!0===r&&d.length>0?function(t){if(!t.proxy)throw new Error("Proxy not provided");if("string"==typeof t.proxy){const e=f.default.parse(t.proxy);t.proxy=Object.assign(Object.assign({},e),{port:Number(e.port)})}const e=t.proxy;t.endServerProtocol||(t.endServerProtocol="https:");let r;r="http:"===e.protocol?"http:"===t.endServerProtocol?l.default.httpOverHttp(t):l.default.httpsOverHttp(t):"http:"===t.endServerProtocol?l.default.httpOverHttps(t):l.default.httpsOverHttps(t);return r}({proxy:t,endServerProtocol:"https:",rejectUnauthorized:!0,ca:d}):new i.HttpsProxyAgent(t):!0===r&&d.length>0&&(y=new p.Agent({rejectUnauthorized:!0,ca:d}))}else if("http:"===e.protocol.trim()){const t=s.config.getString(s.types.HTTP_PROXY);t&&(y=new o.HttpProxyAgent(t))}return a.set(t,y),y};