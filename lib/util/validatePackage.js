"use strict";var e=this&&this.__createBinding||(Object.create?function(e,n,t,a){void 0===a&&(a=t);var o=Object.getOwnPropertyDescriptor(n,t);o&&!("get"in o?!n.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return n[t]}}),Object.defineProperty(e,a,o)}:function(e,n,t,a){void 0===a&&(a=t),e[a]=n[t]}),n=this&&this.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),t=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var a={};if(null!=t)for(var o in t)"default"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&e(a,t,o);return n(a,t),a},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.done=exports.validatePackageName=exports.validateTag=exports.validateDependence=exports.validateVersion=exports.validateLength=exports.validateSize=exports.validateHmPackage=void 0;const o=require("./similar"),s=a(require("semver/functions/valid")),i=t(require("fs-extra")),r=a(require("path")),c=require("../common/Constants"),l=(require("./FsUtil"),/^(?:@([^/]+?)[/])?([^/]+?)$/),h=/^[0-9A-Za-z.\-_]+$/,u=[c.Constants.MyModules,"node_modules","favicon.ico"],d=/(?=^[a-zA-Z0-9_\-.]+@[a-zA-Z0-9_\-.]*[.]+[a-zA-Z0-9_\-.]*$).{1,64}/;var f,p,m;function g(e,n){return i.existsSync(r.default.resolve(e,n))}function y(e,n=!1){const t=[],a=[];return null===e?(a.push("name cannot be null"),v(t,a)):void 0===e?(a.push("name cannot be undefined"),v(t,a)):(e.length||a.push("name length must be greater than zero"),e.match(/^\./)&&a.push("name cannot start with a period"),e.match(/^_/)&&a.push("name cannot start with an underscore"),e.trim()!==e&&a.push("name cannot contain leading or trailing spaces"),u.forEach((function(n){e.toLowerCase()===n&&a.push(`${n}  is a blacklisted name`)})),e.length>128&&a.push("name cannot contain more than 128 characters"),e.toLowerCase()!==e&&a.push("name cannot contain capital letters"),/[~'!()*]/.test(e.split("/").slice(-1)[0])&&a.push('name cannot contain special characters ("~\'!()*")'),0===a.length&&(l.test(e)||a.push("name contains invalid characters")),null==n||n||o.similar.forEach((function(n){e.toLowerCase()===n&&a.push(`${n} is a core module name`)})),v(t,a))}function v(e,n){return{validForPackages:0===n.length,errors:n}}!function(e){e.ORIGINAL="original",e.OBFUSCATE="obfuscation",e.BYTECODE="bytecode"}(f||(f={})),function(e){e.ANDROID="android",e.IOS="ios",e.OPENHARMONY="openharmony"}(p||(p={})),function(e){e.CONFIG_JSON="src/main/config.json",e.MODULE_JSON="src/main/module.json",e.MODULE_JSON5="src/main/module.json5"}(m||(m={})),exports.validateHmPackage=function(e,n){const t=[],a=[],o=e.main;o||t.push(`The main field in the ${c.Constants.MyPackageJson} file is empty.`),g(n,o)||t.push(`The declare file does not exist: ${o}.`);try{const o=e.artifactType;if(null==o||o===f.ORIGINAL)return v(a,t);if(o!==f.ORIGINAL&&o!==f.OBFUSCATE&&o!==f.BYTECODE)return t.push(`The value of artifactType field in the ${c.Constants.MyPackageJson} must be ${f.ORIGINAL}, ${f.BYTECODE} or ${f.OBFUSCATE}.`),v(a,t);const s=e.types;if(!s)return t.push(`The types field in the ${c.Constants.MyPackageJson} file is empty.`),v(a,t);i.existsSync(r.default.resolve(n,s))||t.push(`The declare file does not exist: ${s}.`)}catch(e){return v(a,t)}return v(a,t)},exports.validateSize=function(e){const n=[],t=e.unpackedSize,a=e.files.length,o=e.size;return t>c.Constants.MaxUnpackSize&&n.push("total file size is more than 50M"),o>c.Constants.MaxPackSize&&n.push("total pack size is more than 10M"),a>c.Constants.TotalFiles&&n.push("total number of files is more than 10240"),v([],n)},exports.validateLength=function(e){const n=[],t=[];return null===e.version||void 0===e.version||e.version.length>64?(n.push(`The version field in the ${c.Constants.MyPackageJson} file cannot be empty or contains more than 64 characters.`),v(t,n)):null===e.description||void 0===e.description||e.description.length<30||e.description.length>512?(n.push(`The description field in the ${c.Constants.MyPackageJson} file cannot contain less than 30 or more than 512 characters.`),v(t,n)):null!==e.license&&void 0!==e.license&&e.license.length>256?(n.push(`The license field in the ${c.Constants.MyPackageJson} file cannot contain more than 256 characters.`),v(t,n)):null!==e.repository&&void 0!==e.repository&&e.repository.length>1024?(n.push(`The repository field in ${c.Constants.MyPackageJson} file cannot contain more than 1024 characters.`),v(t,n)):null!==e.homepage&&void 0!==e.homepage&&e.homepage.length>1024?(n.push(`The homepage field in the ${c.Constants.MyPackageJson} file cannot contain more than 1024 characters.`),v(t,n)):null===e.keywords||void 0===e.keywords||e.keywords instanceof Array?null!==e.keywords&&void 0!==e.keywords&&e.keywords.length>10?(n.push(`The keywords field in ${c.Constants.MyPackageJson} file cannot contain more than 10.`),v(t,n)):null!==e.keywords&&void 0!==e.keywords&&e.keywords.some((e=>e.length>20||0===e.length))?(n.push(`Each keyword in keywords field of the ${c.Constants.MyPackageJson} file cannot be empty or contain more than 20 characters.`),v(t,n)):!e.author||!e.author.name||e.author.name.length>128?(n.push(`The name in author field of the ${c.Constants.MyPackageJson} file cannot be empty or contain more than 128 characters.`),v(t,n)):e.author.email&&e.author.email.length>64?(n.push(`The email in author field of the ${c.Constants.MyPackageJson} file cannot contain more than 64 characters.`),v(t,n)):e.author.email&&!d.test(e.author.email)?(n.push(`The format of the OHPM package email in the ${c.Constants.MyPackageJson} is invalid. You should follow the xxx@xxx.xxx format`),v(t,n)):v(t,n):(n.push(`The keywords field in the ${c.Constants.MyPackageJson} file must be an array.`),v(t,n))},exports.validateVersion=function(e){const n=[];return(0,s.default)(e)||n.push(`The version field: ${e} in the ${c.Constants.MyPackageJson} file does not satisfy the semver specification.`),v([],n)},exports.validateDependence=function(e){const n=[],t=[];return null==e||Object.keys(e).forEach((e=>{y(e,!0).validForPackages||n.push(`Invalid package name: ${e} in dependency field of the ${c.Constants.MyPackageJson} file.`)})),v(t,n)},exports.validateTag=function(e){const n=[];return null!=e&&e.length>128&&n.push("The tag field cannot contain more than 128 characters."),null==e||h.test(e)||n.push(`The tag field: ${e} can only contain numbers, letters and ._- symbols.`),v([],n)},exports.validatePackageName=y,exports.done=v;